# 《Kubernetes设计模式》深度解析与实战课程教案（按章节）

## 第一章：云原生基础（6学时）

### 1. 教学目的与要求
- 理解云原生的核心理念和价值
- 掌握容器化的基本概念和Docker操作
- 了解Kubernetes的基本架构和核心组件
- 能够将简单应用容器化并部署到Kubernetes

### 2. 教学重点难点
**重点：**
- 云原生架构的演进路径和核心价值
- 容器化技术的基本原理和操作
- Kubernetes的核心概念和组件

**难点：**
- 从传统架构到云原生架构的思维转变
- 容器镜像的优化和最佳实践
- Kubernetes组件间的协作机制

### 3. 教学过程
#### 理论部分（4学时）
- **云原生架构演进**（1学时）
  - 单体架构的局限性
  - 微服务架构的优势与挑战
  - 云原生的定义与核心价值（弹性、可观测性、韧性）
  - Kubernetes在云原生中的地位

- **容器化基础**（1学时）
  - 容器vs虚拟机
  - Docker基本概念和操作
  - Dockerfile编写和最佳实践
  - 容器镜像分层原理

- **Kubernetes核心概念**（1学时）
  - Kubernetes架构（Master/Node组件）
  - 核心抽象（Pod、Service、Label、Namespace）
  - 声明式API与控制器模式
  - kubectl基本操作

#### 实践部分（2学时）
- **容器化实践**（1学时）
  - 安装Docker环境
  - 编写Dockerfile并构建镜像
  - 容器运行和管理

- **Kubernetes环境搭建**（1学时）
  - 使用minikube或kind搭建本地Kubernetes环境
  - 部署第一个应用到Kubernetes
  - 验证Pod和Service的基本功能

### 4. 思考题及作业题
1. 思考题：传统单体架构与微服务架构各有哪些优缺点？在什么场景下应该选择微服务架构？
2. 思考题：容器与虚拟机有什么区别？各有什么优缺点？
3. 作业题：选择一个简单的Web应用（如Flask、Express等），编写Dockerfile将其容器化，并提交构建过程和运行结果截图
4. 作业题：将容器化的应用部署到Kubernetes集群，创建Service使其可访问，并提交相关YAML文件和验证结果

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解云原生的核心理念和价值
- 掌握容器化的基本概念和Docker操作
- 了解Kubernetes的基本架构和核心组件
- 能够将简单应用容器化并部署到Kubernetes
- 初步建立云原生思维，为后续深入学习打下基础

---

## 第二章：资源管理（4学时）

### 1. 教学目的与要求
- 理解Kubernetes中的资源管理机制
- 掌握资源请求与限制的配置方法
- 了解命名空间级资源管理工具
- 能够设计合理的资源分配策略

### 2. 教学重点难点
**重点：**
- 可压缩资源与不可压缩资源的区别
- 资源请求与限制的配置和作用
- ResourceQuota和LimitRange的使用

**难点：**
- 资源超限的处理机制
- 多租户环境下的资源隔离与共享
- 应用资源需求的合理评估

### 3. 教学过程
#### 理论部分（2学时）
- **资源管理基础**（1学时）
  - 可压缩资源(CPU)与不可压缩资源(Memory)
  - cgroup原理简介
  - 资源请求(Requests)与限制(Limits)的概念
  - OOMKilled与CPU节流机制

- **高级资源管理**（1学时）
  - ResourceQuota：命名空间资源配额
  - LimitRange：默认资源限制
  - Pod优先级与抢占
  - 容量规划方法论

#### 实践部分（2学时）
- **资源限制实验**（1学时）
  - 配置Pod的资源请求与限制
  - 模拟资源超限场景
  - 观察OOMKilled现象

- **命名空间资源管理**（1学时）
  - 创建ResourceQuota
  - 配置LimitRange
  - 验证资源限制效果
  - 多租户资源隔离实践

### 4. 思考题及作业题
1. 思考题：为什么CPU被视为"可压缩"资源而内存被视为"不可压缩"资源？这种区别对应用设计有什么影响？
2. 思考题：在生产环境中，如何确定一个应用的合理资源请求和限制值？
3. 作业题：设计一个实验，分别测试CPU限制和内存限制对应用性能的影响，并记录观察结果
4. 作业题：为一个多团队共享的Kubernetes集群设计资源管理策略，包括命名空间划分、ResourceQuota和LimitRange配置

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解Kubernetes中的资源管理机制
- 掌握资源请求与限制的配置方法
- 了解命名空间级资源管理工具的使用
- 能够设计合理的资源分配策略
- 具备处理资源相关问题的能力

---

## 第三章：声明式部署（4学时）

### 1. 教学目的与要求
- 理解声明式API的核心理念
- 掌握Deployment资源的配置和管理
- 了解不同部署策略的特点和适用场景
- 能够实现应用的零停机更新和回滚

### 2. 教学重点难点
**重点：**
- Deployment资源的配置和管理
- 滚动更新的参数调整和监控
- 不同部署策略的选择依据

**难点：**
- 理解滚动更新的内部机制
- 蓝绿部署和金丝雀发布的实现
- 复杂场景下的部署策略选择

### 3. 教学过程
#### 理论部分（2学时）
- **声明式部署基础**（1学时）
  - 声明式API vs 命令式API
  - Deployment资源详解
  - ReplicaSet与Pod的关系
  - 滚动更新机制

- **高级部署策略**（1学时）
  - 蓝绿部署(Blue-Green Release)
  - 金丝雀发布(Canary Release)
  - A/B测试部署
  - GitOps实践简介

#### 实践部分（2学时）
- **滚动更新实践**（1学时）
  - 创建Deployment资源
  - 配置和触发滚动更新
  - 监控更新进度
  - 执行回滚操作

- **高级部署策略实践**（1学时）
  - 实现蓝绿部署
  - 配置金丝雀发布
  - 使用Helm部署复杂应用
  - 灰度发布流量控制

### 4. 思考题及作业题
1. 思考题：滚动更新过程中，如何确保服务的连续性？`maxSurge`和`maxUnavailable`参数如何影响更新过程？
2. 思考题：蓝绿部署和金丝雀发布各有什么优缺点？在什么场景下应该选择哪种策略？
3. 作业题：设计一个实验，比较`RollingUpdate`和`Recreate`两种更新策略的区别，记录观察结果
4. 作业题：设计一个金丝雀发布方案，包括流量分配策略、监控指标和回滚机制

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解声明式API的核心理念和优势
- 掌握Deployment资源的配置和管理方法
- 了解不同部署策略的特点和适用场景
- 能够实现应用的零停机更新和回滚
- 具备设计复杂部署流程的能力

---

## 第四章：健康探针（2学时）

### 1. 教学目的与要求
- 理解健康探针的概念和作用
- 掌握不同类型探针的配置和使用方法
- 了解探针在部署过程中的关键作用
- 能够设计合理的健康检查策略

### 2. 教学重点难点
**重点：**
- 区分存活探针、就绪探针和启动探针的职责
- 探针参数的合理配置
- 探针在部署过程中的作用

**难点：**
- 针对不同应用特性选择合适的探针类型
- 处理探针可能引发的问题
- 复杂应用的探针设计

### 3. 教学过程
#### 理论部分（2学时）
- **健康探针基础**（0.5学时）
  - 健康检查的重要性
  - 存活探针(Liveness Probe)详解
  - 就绪探针(Readiness Probe)详解
  - 启动探针(Startup Probe)详解

- **探针高级应用**（0.5学时）
  - 探针的不同实现方式（HTTP、TCP、Exec、gRPC）
  - 探针参数配置（initialDelaySeconds、periodSeconds等）
  - 探针在滚动更新中的作用
  - 复杂应用的探针设计策略

#### 实践部分（1学时）
- **探针配置实践**（0.5学时）
  - 配置存活探针和就绪探针
  - 测试探针失败场景
  - 观察Kubernetes的自动恢复机制

- **探针与部署结合**（0.5学时）
  - 结合探针实现零停机更新
  - 故障注入测试
  - 设计和实现自定义健康检查逻辑
  - 探针调试和问题排查

### 4. 思考题及作业题
1. 思考题：为什么需要区分存活探针和就绪探针？只使用其中一种会有什么问题？
2. 思考题：在什么情况下应该使用启动探针而非就绪探针？两者有什么区别？
3. 作业题：为一个Web应用设计合理的健康检查策略，包括探针类型、检查路径、参数配置等，并解释设计理由
4. 作业题：设计一个实验，比较有健康探针和没有健康探针的应用在滚动更新时的行为差异

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解健康探针的概念和作用
- 掌握不同类型探针的配置和使用方法
- 了解探针在部署过程中的关键作用
- 能够设计合理的健康检查策略
- 具备处理探针相关问题的能力

---

## 第五章：生命周期管理（2学时）

### 1. 教学目的与要求
- 理解Kubernetes中的容器生命周期
- 掌握生命周期钩子的配置和使用方法
- 了解优雅停机的实现机制
- 能够设计应用的生命周期管理策略

### 2. 教学重点难点
**重点：**
- 容器生命周期事件和钩子机制
- preStop钩子的配置和执行流程
- 优雅停机的实现方式

**难点：**
- 处理复杂应用的启动和关闭序列
- 调试钩子执行失败问题
- 集群维护期间的服务可用性保障

### 3. 教学过程
#### 理论部分（1学时）
- **容器生命周期基础**（0.5学时）
  - 容器状态转换流程
  - 生命周期事件（创建、启动、停止、删除）
  - 生命周期钩子（postStart、preStop）
  - SIGTERM和SIGKILL信号处理

- **优雅停机与服务可用性**（0.5学时）
  - 优雅停机的重要性和实现机制
  - terminationGracePeriodSeconds配置
  - PodDisruptionBudget(PDB)详解
  - 集群维护期间的服务可用性保障

#### 实践部分（1学时）
- **生命周期钩子实践**（0.5学时）
  - 配置postStart和preStop钩子
  - 验证钩子执行过程
  - 测试优雅停机效果

- **高可用性实践**（0.5学时）
  - 配置PodDisruptionBudget
  - 模拟节点维护场景
  - 验证服务可用性
  - 集群证书轮换实践

### 4. 思考题及作业题
1. 思考题：为什么Kubernetes在发送SIGKILL信号前会先发送SIGTERM信号？这种设计有什么优势？
2. 思考题：如何确保在集群维护（如节点升级）期间服务仍然可用？PodDisruptionBudget如何帮助实现这一目标？
3. 作业题：设计一个包含数据库连接的应用的优雅停机方案，包括preStop钩子配置和超时设置
4. 作业题：设计一个实验，比较有preStop钩子和没有preStop钩子的Pod在终止时的行为差异

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解Kubernetes中的容器生命周期
- 掌握生命周期钩子的配置和使用方法
- 了解优雅停机的实现机制
- 能够设计应用的生命周期管理策略
- 具备保障服务可用性的能力

---

## 第六章：高级调度（4学时）

### 1. 教学目的与要求
- 理解Kubernetes调度器的工作原理
- 掌握节点亲和性、Pod亲和性的配置方法
- 了解污点与容忍度的作用和使用场景
- 能够设计复杂的调度策略

### 2. 教学重点难点
**重点：**
- 调度器的过滤和打分机制
- 节点亲和性与Pod亲和性的配置
- 污点与容忍度的使用场景

**难点：**
- 理解不同调度策略的组合使用
- 复杂调度需求的实现
- 大规模集群的调度优化

### 3. 教学过程
#### 理论部分（2学时）
- **调度基础**（1学时）
  - 调度器工作原理（过滤和打分）
  - 节点亲和性(Node Affinity)详解
  - 调度器扩展点简介
  - 自定义调度器概念

- **高级调度策略**（1学时）
  - Pod亲和性与反亲和性(Pod Affinity/Anti-Affinity)
  - 污点与容忍度(Taints and Tolerations)
  - 拓扑分布约束(Topology Spread Constraints)
  - 节点选择器与节点标签

#### 实践部分（2学时）
- **基础调度实践**（1学时）
  - 配置节点亲和性
  - 测试节点选择效果
  - 实现特定节点调度

- **高级调度实践**（1学时）
  - 配置Pod亲和性与反亲和性
  - 设置污点与容忍度
  - 实现复杂调度策略
  - 验证调度结果

### 4. 思考题及作业题
1. 思考题：节点亲和性和Pod亲和性有什么区别？在什么场景下应该使用哪种？
2. 思考题：如何使用污点和容忍度实现专用节点？这种方式与节点亲和性相比有什么优势？
3. 作业题：设计一个高可用的Web应用部署方案，要求应用的多个副本分布在不同的可用区，并且与其依赖的Redis缓存部署在同一个节点上
4. 作业题：设计一个包含多种调度约束的应用部署方案，并分析可能的调度结果

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解Kubernetes调度器的工作原理
- 掌握节点亲和性、Pod亲和性的配置方法
- 了解污点与容忍度的作用和使用场景
- 能够设计复杂的调度策略
- 具备优化资源分布的能力

---

## 第七章：行为模式（6学时）

### 1. 教学目的与要求
- 理解Kubernetes中的不同Pod管理模式
- 掌握Job、CronJob、DaemonSet、StatefulSet的配置和使用
- 了解无状态服务和有状态服务的区别
- 能够为不同类型的应用选择合适的控制器

### 2. 教学重点难点
**重点：**
- 不同控制器的特性和适用场景
- 有状态服务的存储和网络管理
- 批处理任务和定时任务的配置

**难点：**
- StatefulSet的唯一性和稳定性保证
- 复杂任务的分片与并行处理
- 有状态应用的部署和管理

### 3. 教学过程
#### 理论部分（4学时）
- **任务型作业**（1学时）
  - Job资源详解
  - CronJob资源详解
  - 批处理任务的并行控制
  - 任务失败处理策略

- **守护服务与单例服务**（1学时）
  - DaemonSet详解
  - DaemonSet的更新策略
  - StatefulSet基础概念
  - 控制器选择依据

- **有状态服务管理**（1学时）
  - 无状态vs有状态服务
  - StatefulSet的存储和网络特性
  - Headless Service原理
  - PV/PVC生命周期

- **服务发现与访问**（1学时）
  - 内部服务发现机制
  - 外部服务访问方式
  - Ingress资源详解
  - 服务网格简介

#### 实践部分（4学时）
- **Job与CronJob实践**（1学时）
  - 创建简单Job
  - 配置并行任务
  - 设置CronJob定时任务
  - 验证任务执行结果

- **DaemonSet与StatefulSet实践**（1学时）
  - 部署DaemonSet
  - 验证每节点一个Pod
  - 创建StatefulSet
  - 观察稳定网络标识

- **有状态应用部署**（1学时）
  - 部署MySQL主从集群
  - 配置持久化存储
  - 验证数据持久性
  - 测试故障恢复

- **服务发现与DevOps实践**（1学时）
  - 配置内部服务访问
  - 设置Ingress外部访问
  - 实现CI/CD流水线
  - 多环境发布策略

### 4. 思考题及作业题
1. 思考题：Job和CronJob与普通的Deployment有什么本质区别？它们的控制器行为有何不同？
2. 思考题：为什么说"有状态服务比无状态服务更难管理"？具体难在哪里？
3. 作业题：设计一个数据处理任务，要求能够并行处理多个数据分片，并在所有分片处理完成后执行一个汇总操作
4. 作业题：设计一个MySQL主从复制集群的部署方案，使用StatefulSet和适当的初始化脚本
5. 思考题：如何处理有状态应用的备份和恢复？这与无状态应用有何不同？
6. 作业题：设计一个监控系统的部署方案，包括在每个节点上运行的收集器（使用DaemonSet）和一个中央聚合服务（使用StatefulSet）

### 5. 课堂小结
通过本章学习，学生应该能够：
- 理解Kubernetes中的不同Pod管理模式
- 掌握Job、CronJob、DaemonSet、StatefulSet的配置和使用
- 了解无状态服务和有状态服务的区别
- 能够为不同类型的应用选择合适的控制器
- 具备设计和实现复杂应用部署的能力

---

## 综合实践与复习总结（4学时）

### 1. 教学目的与要求
- 掌握在华为云CCE服务中部署Kubernetes集群和应用的完整流程
- 理解公有云Kubernetes服务的特点和优势
- 能够将本地设计的Kubernetes部署方案迁移到公有云环境
- 回顾和巩固课程所学的核心知识点和技能
- 培养团队协作能力和项目实战经验

### 2. 教学重点难点
**重点：**
- 华为云CCE服务的使用与配置
- 本地Kubernetes部署方案向公有云的迁移
- 云原生项目开发与部署的完整流程
- 课程核心知识点的系统回顾

**难点：**
- 公有云资源的合理规划和配置
- 跨环境部署的兼容性问题解决
- 团队协作开发与部署的协调

### 3. 教学过程

#### 实验部分（2学时）：公有云端服务部署实践

**教学内容：**
- **华为云CCE平台介绍**（0.5学时）
  - 华为云CCE服务的架构和特点
  - 集群类型与节点规格选择
  - 安全组和网络配置
  - 费用模型与优化策略

- **华为云CCE集群创建与配置**（1.5学时）
  - 注册华为云账号并开通CCE服务
  - 创建Kubernetes集群（选择合适的版本和节点规格）
  - 配置集群网络和存储
  - 连接集群并验证功能

**实验步骤：**
1. 学生分组（3-4人一组）
2. 各组准备本地设计的Kubernetes部署方案
3. 在华为云上创建CCE集群
4. 配置镜像仓库并上传应用镜像
5. 调整部署配置文件，适配公有云环境
6. 部署应用并验证功能
7. 记录部署过程中的问题和解决方案
8. 每组进行5分钟的部署情况汇报

**实验要求：**
- 每组提交完整的部署文档，包括环境准备、配置步骤、遇到的问题及解决方案
- 提交部署成功的截图和验证结果
- 撰写实验总结，分析公有云部署与本地部署的差异

#### 理论部分（2学时）：课程总结与复习

**教学内容：**
- **项目部署情况汇总与点评**（1学时）
  - 各组项目部署情况分析
  - 优秀实践案例展示
  - 常见问题与改进建议

- **云原生项目开发与部署完整流程**（1学时）
  - 需求分析与架构设计
  - 应用容器化与镜像管理
  - Kubernetes资源配置与优化
  - CI/CD流水线设计与实现
  - 监控与可观测性方案

- **课程核心知识点回顾**（0.5学时）
  - 云原生基础概念与架构
  - Kubernetes核心组件与资源对象
  - 资源管理与调度策略
  - 应用部署与服务管理
  - 有状态服务与无状态服务管理

- **未来发展与职业规划**（0.5学时）
  - 云原生技术发展趋势
  - Kubernetes生态系统与周边工具
  - 云原生相关认证与职业路径
  - 学习资源与社区参与建议

### 4. 思考题及作业题
1. 思考题：公有云Kubernetes服务与自建Kubernetes集群相比，有哪些优势和劣势？在什么场景下应该选择公有云服务？
2. 思考题：在将本地部署方案迁移到公有云时，需要考虑哪些兼容性问题？如何解决？
3. 作业题：以小组为单位，完成公有云端服务部署的实验报告，包括详细的步骤、遇到的问题及解决方案、实验总结
4. 作业题：个人总结课程学习收获，分析自己在云原生技术方面的优势和不足，并制定未来学习计划
5. 思考题：云原生技术的发展对传统IT架构和开发模式带来了哪些变革？作为技术人员，如何适应这些变革？

### 5. 课堂小结
通过最后两周的学习，学生应该能够：
- 掌握在华为云CCE服务中部署Kubernetes集群和应用的方法
- 理解公有云Kubernetes服务的特点和应用场景
- 能够将本地设计的Kubernetes部署方案迁移到公有云环境
- 系统回顾和巩固课程所学的核心知识点
- 培养团队协作能力和解决实际问题的能力
- 对云原生技术的发展趋势和职业规划有更清晰的认识